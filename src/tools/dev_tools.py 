# tools/dev_tools.py
import os
import sys
import json
import subprocess
import shutil
from typing import Dict, Any, List

# Attempt to import core dependencies, use minimal mocks if they fail
try:
    from engine.core.engine_config import EngineConfig
    from engine.utils.file_utils import FileUtils
    from engine.utils.json_schema import JsonSchema
except ImportError as e:
    print(f"[DevTools Import Error] {e}. Using Internal Mocks.")
    class EngineConfig:
        def __init__(self): self.editor_settings = {"default_project_path": os.path.join(FileUtils.get_engine_root_path(), 'projects')}
    class FileUtils:
        @staticmethod
        def log_message(msg): print(f"[DT-INFO] {msg}")
        @staticmethod
        def log_error(msg): print(f"[DT-ERROR] {msg}", file=sys.stderr)
        @staticmethod
        def log_warning(msg): print(f"[DT-WARN] {msg}")
        @staticmethod
        def read_json(path): return {}
        @staticmethod
        def write_json(path, data): pass
        @staticmethod
        def get_engine_root_path(): return os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..'))
    class JsonSchema:
        @staticmethod
        def validate_schema(data, schema): return []


class DevTools:
    """
    A collection of command-line or editor-integrated tools for developers 
    to manage the engine, projects, and assets.
    """
    
    def __init__(self):
        self.config = EngineConfig()

    def run_clean(self):
        """Removes temporary files, build directories, and log files."""
        FileUtils.log_message("Starting full cleanup operation...")
        
        # 1. Remove Logs
        try:
            shutil.rmtree(os.path.join(FileUtils.get_engine_root_path(), 'logs'), ignore_errors=True)
            FileUtils.log_message("Cleaned: Logs directory.")
        except:
            pass

        # 2. Remove Temporary Files
        try:
            shutil.rmtree(os.path.join(FileUtils.get_engine_root_path(), 'temp'), ignore_errors=True)
            FileUtils.log_message("Cleaned: Temp directory.")
        except:
            pass

        # 3. Remove Build Directories
        try:
            shutil.rmtree(os.path.join(FileUtils.get_engine_root_path(), 'builds'), ignore_errors=True)
            FileUtils.log_message("Cleaned: Builds directory.")
        except:
            pass
            
        # 4. Remove Mock Workshop Server Data
        try:
            shutil.rmtree(os.path.join(FileUtils.get_engine_root_path(), 'workshop_server'), ignore_errors=True)
            FileUtils.log_message("Cleaned: Workshop Server mock data.")
        except:
            pass

        FileUtils.log_message("Cleanup complete.")

    def run_schema_check(self, project_name: str = 'example_project'):
        """
        Validates the project.json and main_scene.json against a minimal internal schema (mock).
        """
        FileUtils.log_message(f"Running schema validation for project: {project_name}")
        
        project_path = os.path.join(self.config.editor_settings.get("default_project_path"), project_name)
        
        # 1. Validate project.json
        proj_json_path = os.path.join(project_path, 'project.json')
        proj_data = FileUtils.read_json(proj_json_path)
        
        # Mock Project Schema (Real schema is more complex)
        proj_schema = {
            "name": {"type": "string", "required": True},
            "main_scene": {"type": "string", "required": True},
            "is_3d": {"type": "boolean", "required": True},
        }
        
        errors = JsonSchema.validate_schema(proj_data, proj_schema)
        if errors:
            FileUtils.log_error(f"Project config {proj_json_path} failed validation:")
            for err in errors: FileUtils.log_error(f"  - {err}")
        else:
            FileUtils.log_message(f"Project config {proj_json_path} passed validation.")
            
        # 2. Validate main scene file (Mock validation against a generic structure)
        main_scene_path = os.path.join(project_path, proj_data.get('main_scene', 'main_scene.json'))
        scene_data = FileUtils.read_json(main_scene_path)
        
        scene_schema = {
            "name": {"type": "string", "required": True},
            "objects": {"type": "list", "required": True}
        }
        
        errors = JsonSchema.validate_schema(scene_data, scene_schema)
        if errors:
            FileUtils.log_error(f"Scene file {main_scene_path} failed validation:")
            for err in errors: FileUtils.log_error(f"  - {err}")
        else:
            FileUtils.log_message(f"Scene file {main_scene_path} passed validation.")


    def list_missing_assets(self, project_name: str = 'example_project'):
        """Scans a project's scene/config files and reports assets referenced but not found on disk."""
        FileUtils.log_warning("Asset check not fully implemented. Mocking asset scan.")
        
        # This is highly complex and requires parsing ALL scene objects and their components
        # to extract 'asset' fields.
        
        missing = ["missing_texture.png", "missing_sound.wav"] # Mock list
        
        if missing:
            FileUtils.log_warning(f"Project '{project_name}' has {len(missing)} potentially missing assets:")
            for m in missing: FileUtils.log_warning(f"  - {m}")
        else:
            FileUtils.log_message(f"Project '{project_name}' asset scan found no missing references.")


    def open_external_tool(self, tool_name: str):
        """Mock: Executes an external command (e.g., code editor, blender)."""
        if tool_name == 'code':
            command = ['code', FileUtils.get_engine_root_path()] # VS Code mock
        elif tool_name == 'blender':
            command = ['blender'] # Blender mock
        else:
            FileUtils.log_error(f"Unknown external tool: {tool_name}")
            return

        FileUtils.log_message(f"Attempting to launch external tool: {tool_name}")
        try:
            # subprocess.Popen(command) # Actual execution is commented out for safety
            FileUtils.log_message(f"Command executed: {command}")
        except Exception as e:
            FileUtils.log_error(f"Failed to launch {tool_name}: {e}")


# --- Command Line Interface ---
if __name__ == '__main__':
    dev_tools = DevTools()
    
    if len(sys.argv) > 1:
        command = sys.argv[1].lower()
        if command == 'clean':
            dev_tools.run_clean()
        elif command == 'schemacheck':
            project = sys.argv[2] if len(sys.argv) > 2 else 'example_project'
            dev_tools.run_schema_check(project)
        elif command == 'missingassets':
            project = sys.argv[2] if len(sys.argv) > 2 else 'example_project'
            dev_tools.list_missing_assets(project)
        else:
            FileUtils.log_error(f"Unknown dev tool command: {command}")
    else:
        FileUtils.log_message("DevTools CLI: Usage: python dev_tools.py [clean|schemacheck <project>|missingassets <project>]")